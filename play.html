<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 幸运大抽奖</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        .input-group {
            margin-bottom: 20px;
        }

        .name-input {
            padding: 10px;
            font-size: 1.1rem;
            border-radius: 5px;
            border: 2px solid var(--gold);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            width: 80%;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>✨ 幸运大转盘 ✨</h1>

        <!-- Name Input Section -->
        <div class="input-group">
            <input type="text" id="userName" class="name-input" placeholder="请输入您的姓名" maxlength="10">
        </div>

        <div class="draw-btn-container">
            <button id="drawBtn" class="draw-btn">点我<br>抽奖</button>
        </div>

        <p class="instruction">每人仅限一次，祝您好运！</p>
    </div>

    <!-- Result Modal -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <div class="prize-title">恭喜 <span id="winnerName"></span> 获得</div>
            <div id="prizeName" class="prize-name">特等奖</div>
            <button class="close-btn" onclick="closeModal()">开心收下</button>
        </div>
    </div>

    <script>
        const prizes = [
            { name: "特等奖：新款手机", weight: 0.01 },
            { name: "一等奖：平板电脑", weight: 0.03 },
            { name: "二等奖：智能手表", weight: 0.05 },
            { name: "三等奖：机械键盘", weight: 0.08 },
            { name: "四等奖：蓝牙耳机", weight: 0.10 },
            { name: "五等奖：精美手办", weight: 0.12 },
            { name: "六等奖：大容量充电宝", weight: 0.15 },
            { name: "七等奖：视频会员年卡", weight: 0.15 },
            { name: "八等奖：星巴克兑换券", weight: 0.15 },
            { name: "幸运奖：随机现金红包", weight: 0.16 }
        ];

        const drawBtn = document.getElementById('drawBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const prizeNameEl = document.getElementById('prizeName');
        const userNameInput = document.getElementById('userName');
        const winnerNameEl = document.getElementById('winnerName');

        // MQTT Setup
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room'); // Get room from QR code
        let mqttClient = null;

        if (roomId) {
            mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            mqttClient.on('connect', () => {
                console.log('MQTT Connected');
                // Subscribe to Reset Signal
                mqttClient.subscribe(`luckydraw/${roomId}/reset`);
            });

            mqttClient.on('message', (topic, message) => {
                if (topic.includes('reset')) {
                    console.log("Reset signal received!");
                    resetLocalState();
                }
            });
        } else {
            console.warn("No room ID found in URL");
        }

        function resetLocalState() {
            // Clear storage
            localStorage.removeItem('drawHistory');

            // Reset UI
            drawBtn.disabled = false;
            drawBtn.classList.remove('disabled');
            drawBtn.innerHTML = "点我<br>抽奖";
            userNameInput.style.display = 'block';
            userNameInput.value = '';

            const instruction = document.querySelector('.instruction');
            instruction.innerHTML = '每人仅限一次，祝您好运！';

            alert("主持人开启了新一轮抽奖！您可以再来一次了！");

            // Close modal if open
            modalOverlay.classList.remove('show');
        }

        // Check if already played
        checkPlayedStatus();

        function checkPlayedStatus() {
            const history = localStorage.getItem('drawHistory');
            if (history) {
                const data = JSON.parse(history);
                lockState(data.prize);
            }
        }

        function lockState(prizeName) {
            drawBtn.disabled = true;
            drawBtn.classList.add('disabled');
            drawBtn.innerHTML = "已抽过";
            userNameInput.style.display = 'none';

            const instruction = document.querySelector('.instruction');
            instruction.innerHTML = `您已获得：<span style="color:var(--gold)">${prizeName}</span>`;
        }

        function getRandomPrize() {
            const rand = Math.random();
            let accumulatedWeight = 0;
            for (const prize of prizes) {
                accumulatedWeight += prize.weight;
                if (rand < accumulatedWeight) {
                    return prize.name;
                }
            }
            return prizes[prizes.length - 1].name;
        }

        function fireConfetti() {
            var count = 200;
            var defaults = { origin: { y: 0.7 } };
            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }
            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
        }

        drawBtn.addEventListener('click', () => {
            const name = userNameInput.value.trim();
            if (!name) { alert("请先输入您的姓名！"); return; }
            if (localStorage.getItem('drawHistory')) { alert("您已经抽过奖啦！"); return; }

            drawBtn.disabled = true;
            drawBtn.classList.add('disabled');
            drawBtn.innerHTML = "抽奖中...";

            setTimeout(() => {
                const prize = getRandomPrize();
                prizeNameEl.textContent = prize;
                winnerNameEl.textContent = name;

                // Save Record
                const record = { name: name, prize: prize, time: new Date().toISOString() };
                localStorage.setItem('drawHistory', JSON.stringify(record));

                // --- SYNC TO HOST ---
                if (mqttClient && mqttClient.connected) {
                    mqttClient.publish(`luckydraw/${roomId}/newWinner`, JSON.stringify({
                        name: name,
                        prize: prize
                    }));
                }

                // Show Result
                modalOverlay.classList.add('show');
                fireConfetti();
            }, 2000);
        });

        function closeModal() {
            modalOverlay.classList.remove('show');
            const history = localStorage.getItem('drawHistory');
            if (history) {
                const data = JSON.parse(history);
                lockState(data.prize);
            }
        }
    </script>
</body>

</html>