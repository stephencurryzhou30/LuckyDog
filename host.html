<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½å¥–æ´»åŠ¨ - ä¸»æŒäºº</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        .layout {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            text-align: left;
        }

        .monitor-panel {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--gold);
            border-radius: 15px;
            width: 300px;
            height: 400px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .monitor-title {
            color: var(--gold);
            font-size: 1.2rem;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
            text-align: center;
        }

        .winner-item {
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            animation: slideIn 0.5s ease;
        }

        .winner-name {
            font-weight: bold;
            color: #fff;
        }

        .winner-prize {
            color: var(--gold);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 800px) {
            .layout {
                flex-direction: column;
                align-items: center;
            }

            .monitor-panel {
                width: 100%;
                height: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="container" style="max-width: 900px;">
        <h1>ğŸ‰ æ‰«ç å‚ä¸æŠ½å¥–</h1>

        <div class="layout">
            <!-- Left: QR Code -->
            <div class="qr-card" style="flex: 1;">
                <div style="margin-bottom: 15px;">
                    <label for="ipInput" style="color:#ddd; font-size:0.9rem;">æœåŠ¡å™¨ IP åœ°å€:</label>
                    <input type="text" id="ipInput" value="" placeholder="ä¾‹å¦‚ 192.168.1.5"
                        style="padding:5px; border-radius:5px; border:none; text-align:center; width: 150px;">
                    <button onclick="updateQR()"
                        style="padding:5px 10px; cursor:pointer; background:var(--gold); border:none; border-radius:5px; font-weight:bold;">ç”Ÿæˆ</button>
                    <div id="statusDot"
                        style="display:inline-block; width:10px; height:10px; background:red; border-radius:50%; margin-left:10px;"
                        title="è¿æ¥çŠ¶æ€"></div>
                </div>

                <div id="qrcode" class="qr-placeholder"></div>
                <p class="instruction">è¯·ç¡®ä¿æ‰‹æœºå’Œç”µè„‘è¿æ¥åŒä¸€ WiFi</p>
                <!-- URL Display hidden as requested -->
            </div>

            <!-- Right: Live Winners -->
            <div class="monitor-panel">
                <div class="monitor-title">ğŸ† å®æ—¶ä¸­å¥–åå•</div>
                <div id="winnerList">
                    <p style="text-align:center; color:#999; font-size:0.8rem;">ç­‰å¾…æŠ½å¥–...</p>
                </div>
                <button onclick="resetRound()"
                    style="width:100%; margin-top:10px; padding:10px; background:rgba(255,0,0,0.5); border:1px solid red; color:white; border-radius:5px; cursor:pointer;">
                    ğŸ”„ å¼€å¯æ–°ä¸€è½® (æ¸…ç©ºè®°å½•)
                </button>
            </div>
        </div>
    </div>

    <script>
        const qrContainer = document.getElementById("qrcode");
        const ipInput = document.getElementById("ipInput");
        const urlDisplay = document.getElementById("urlDisplay");
        const ipContainer = document.querySelector(".qr-card > div:first-child");
        const winnerList = document.getElementById("winnerList");
        const statusDot = document.getElementById("statusDot");

        // Generate a random Room ID for this session
        const roomId = 'room_' + Math.random().toString(36).substr(2, 9);
        console.log("Current Room ID:", roomId);

        // Connect to Public MQTT Broker (WebSockets)
        // Using EMQX public broker
        const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

        client.on('connect', function () {
            statusDot.style.background = '#00ff00'; // Green
            console.log('Connected to MQTT');
            // Subscribe to our specific room topic
            client.subscribe(`luckydraw/${roomId}/newWinner`, function (err) {
                if (!err) {
                    console.log('Subscribed to room topic');
                }
            });
        });

        client.on('message', function (topic, message) {
            // message is Buffer
            try {
                const data = JSON.parse(message.toString());
                addWinner(data.name, data.prize);
            } catch (e) {
                console.error("Parse error", e);
            }
        });

        function addWinner(name, prize) {
            // Remove "Waiting..." placeholder if exists
            if (winnerList.children.length > 0 && winnerList.children[0].tagName === 'P') {
                winnerList.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'winner-item';
            item.innerHTML = `
                <span class="winner-name">${name}</span>
                <span class="winner-prize">${prize}</span>
            `;
            // Insert at top
            winnerList.insertBefore(item, winnerList.firstChild);
        }

        function resetRound() {
            if (!confirm("ç¡®å®šè¦å¼€å¯æ–°ä¸€è½®æŠ½å¥–å—ï¼Ÿ\næ‰€æœ‰äººçš„æ‰‹æœºå°†è¢«é‡ç½®ï¼Œå¯ä»¥å†æ¬¡æŠ½å¥–ã€‚")) return;

            // 1. Clear Host UI
            winnerList.innerHTML = '<p style="text-align:center; color:#999; font-size:0.8rem;">ç­‰å¾…æŠ½å¥–...</p>';

            // 2. Send Reset Signal via MQTT
            if (client.connected) {
                client.publish(`luckydraw/${roomId}/reset`, 'true');
                alert("å·²å‘é€é‡ç½®ä¿¡å·ï¼å¤§å®¶å¯ä»¥é‡æ–°æ‰«ç /åˆ·æ–°æŠ½å¥–äº†ã€‚");
            } else {
                alert("ç½‘ç»œæœªè¿æ¥ï¼Œæ— æ³•å‘é€é‡ç½®ä¿¡å·ã€‚");
            }
        }

        // --- QR Code Logic --- 
        const hostname = window.location.hostname;
        const isLocal = hostname === '127.0.0.1' ||
            hostname === 'localhost' ||
            hostname.startsWith('192.168.') ||
            hostname.startsWith('10.') ||
            hostname.startsWith('172.');

        if (!isLocal && hostname && !hostname.startsWith('file')) {
            if (ipContainer) ipContainer.style.display = 'none';
            ipInput.value = hostname;
            const wifiInstruction = document.querySelector(".instruction");
            if (wifiInstruction) wifiInstruction.style.display = 'none';
        } else {
            if (hostname && hostname !== '127.0.0.1' && hostname !== 'localhost') {
                ipInput.value = hostname;
            } else {
                ipInput.value = "127.0.0.1";
            }
        }

        function updateQR() {
            let path = window.location.pathname;
            path = path.replace('/host.html', '').replace('/index.html', '');
            if (path.endsWith('/')) {
                path = path.slice(0, -1);
            }

            const ip = ipInput.value.trim() || window.location.hostname;
            const port = window.location.port ? ':' + window.location.port : '';
            const protocol = window.location.protocol;

            let playUrl;
            if (!isLocal && hostname && !hostname.startsWith('file')) {
                playUrl = `${protocol}//${hostname}${path}/play.html?room=${roomId}`;
            } else {
                playUrl = `${protocol}//${ip}${port}${path}/play.html?room=${roomId}`;
            }

            console.log("Generated URL:", playUrl);

            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: playUrl,
                width: 250,
                height: 250,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            urlDisplay.textContent = playUrl;
        }

        updateQR();
    </script>
</body>

</html>